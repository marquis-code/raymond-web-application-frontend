import{u as Q,c as V,a as W,b as X}from"./75hiip7X.js";import{r as c,C as R,H as Z,O as ee,f as ae,E as te}from"./DtatyUkd.js";const C={firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",country:"United States"},T={cardNumber:"",cardName:"",expiryDate:"",cvv:""},u=c(1),n=c({items:[],subtotal:0,shipping:0,total:0,tax:0}),r=R({...C}),y=c("standard"),m=c("flutterwave"),N=R({...T}),d=c(!1),p=c(!1),g=c("");c(1);const v=c(null),{loading:se,createOrder:b}=Q();V();const{showToast:l}=te(),P=c(!1);function le(){Z();const{isLoggedIn:z,user:f}=ee(),{setItem:w,getItem:D,removeItem:h}=X(),{handlePayment:L,paymentForm:S,loading:x,updateUserData:A}=W(),j=t=>{t&&t.items&&Array.isArray(t.items)&&(n.value=t);const s=D("checkout-step");s?u.value=Number.parseInt(s):u.value=1,p.value=!1,v.value=null;const e=D("checkout-delivery-details");if(e)try{const a=JSON.parse(e);Object.assign(r,a)}catch(a){console.error("Failed to parse saved delivery details",a)}else z.value&&f.value?(r.firstName=f.value.firstName||"",r.lastName=f.value.lastName||"",r.email=f.value.email||"",r.phone=f.value.phone||""):Object.assign(r,C);const o=D("checkout-delivery-method");o&&["standard","express","pickup"].includes(o)?y.value=o:y.value="standard";const i=D("checkout-payment-method");i&&["flutterwave","interswitch","manual"].includes(i)?m.value=i:m.value="flutterwave",Object.assign(N,T),P.value=!0},U=()=>{u.value<3&&(u.value++,I())},F=()=>{u.value>1&&(u.value--,I())},Y=t=>{y.value=t,w("checkout-delivery-method",t)},_=t=>{m.value=t,w("checkout-payment-method",t)},I=()=>{w("checkout-step",u.value.toString())},O=()=>{w("checkout-delivery-details",JSON.stringify(r))},k=()=>{h("checkout-step"),h("checkout-delivery-details"),h("checkout-delivery-method"),h("checkout-payment-method"),h("checkout-guest-mode")},q=()=>{u.value=1,p.value=!1,v.value=null,Object.assign(r,C),Object.assign(N,T),y.value="standard",m.value="flutterwave",k(),P.value=!1},M=()=>{if(!n.value||!n.value.items||!Array.isArray(n.value.items))throw new Error("Checkout summary is not properly initialized");O();const t=n.value.items.map(e=>({product:e.id.toString(),quantity:e.quantity})),s={firstName:r.firstName,lastName:r.lastName,address:r.address,city:r.city,state:r.state,country:r.country,postalCode:r.zipCode,phone:r.phone,email:r.email};return{items:t,shippingAddress:s,billingAddress:s,notes:`Delivery Method: ${y.value}, Payment Method: ${m.value}`}},J=async()=>{var t,s,e,o;if(!n.value||!n.value.items)return l({title:"Error",message:"Your cart data could not be loaded. Please try refreshing the page.",toastType:"error",duration:3e3}),{success:!1,message:"Cart data not available"};d.value=!0;try{const i=M(),a=await b(i);if(console.log(a,"create order res"),a&&a.type!=="ERROR")return v.value=a,g.value=((t=a==null?void 0:a.data)==null?void 0:t.id)||((s=a==null?void 0:a.data)==null?void 0:s._id)||"INTL-ORD-"+Math.floor(Math.random()*1e6),A({firstName:r.firstName,lastName:r.lastName,email:r.email,phone:r.phone}),S.value.amount=(e=a==null?void 0:a.data)==null?void 0:e.total,S.value.tx_ref=g.value,await L(a==null?void 0:a.data),p.value&&k(),{success:!0};{const E=((o=a==null?void 0:a.data)==null?void 0:o.message)||"Order creation failed";return l({title:"Error",message:E,toastType:"warning",duration:3e3}),{success:!1,message:E}}}catch(i){console.error("Order creation or payment initialization failed",i);const a=(i==null?void 0:i.message)||"Payment processing failed";return l({title:"Payment Error",message:a,toastType:"error",duration:3e3}),{success:!1,message:a}}finally{d.value=!1}},$=async()=>{var t;if(!n.value||!n.value.items)return l({title:"Error",message:"Your cart data could not be loaded. Please try refreshing the page.",toastType:"error",duration:3e3}),{success:!1,message:"Cart data not available"};d.value=!0;try{const s=M(),e=await b(s);if(e&&e.type!=="ERROR")return v.value=e,g.value=e.id||e._id||"INTL-ORD-"+Math.floor(Math.random()*1e6),console.warn("Interswitch payment not configured for international transactions"),l({title:"Payment Method Unavailable",message:"Interswitch payment is not currently available for international transactions.",toastType:"warning",duration:3e3}),{success:!1,message:"Payment method unavailable"};{const o=((t=e==null?void 0:e.data)==null?void 0:t.message)||"Order creation failed";return l({title:"Error",message:o,toastType:"warning",duration:3e3}),{success:!1,message:o}}}catch(s){console.error("Order creation or payment failed",s);const e=(s==null?void 0:s.message)||"Payment processing failed";return l({title:"Payment Error",message:e,toastType:"error",duration:3e3}),{success:!1,message:e}}finally{d.value=!1}},H=async()=>{var t;if(!n.value||!n.value.items)return l({title:"Error",message:"Your cart data could not be loaded. Please try refreshing the page.",toastType:"error",duration:3e3}),{success:!1,message:"Cart data not available"};d.value=!0;try{const s=M(),e=await b(s);if(e&&e.type!=="ERROR")return v.value=e,g.value=e.id||e._id||"INTL-ORD-"+Math.floor(Math.random()*1e6),await new Promise(o=>setTimeout(o,2e3)),p.value=!0,k(),l({title:"Payment Successful",message:"Your order has been placed successfully!",toastType:"success",duration:3e3}),{success:!0};{const o=((t=e==null?void 0:e.data)==null?void 0:t.message)||"Order creation failed";return l({title:"Error",message:o,toastType:"warning",duration:3e3}),{success:!1,message:o}}}catch(s){console.error("Order creation or payment failed",s);const e=(s==null?void 0:s.message)||"Payment processing failed";return l({title:"Payment Error",message:e,toastType:"error",duration:3e3}),{success:!1,message:e}}finally{d.value=!1}},K=async()=>{if(!P.value)return l({title:"Error",message:"Checkout data is not properly initialized. Please refresh the page and try again.",toastType:"error",duration:3e3}),{success:!1,message:"Checkout not initialized"};switch(m.value){case"flutterwave":return J();case"interswitch":return $();case"manual":return H();default:return l({title:"Error",message:"Invalid payment method selected",toastType:"error",duration:3e3}),{success:!1,message:"Invalid payment method"}}},B=t=>t&&v.value?(p.value=!0,d.value=!1,k(),!0):!1,G=()=>{O()};return{checkoutStep:u,checkoutSummary:n,deliveryDetails:r,deliveryMethod:y,paymentMethod:m,cardDetails:N,isProcessing:d,orderComplete:p,orderId:g,orderResponse:v,isInitialized:P,loading:ae(()=>se.value||x.value),initializeCheckout:j,nextStep:U,prevStep:F,setDeliveryMethod:Y,setPaymentMethod:_,processPayment:K,checkPaymentStatus:B,persistDeliveryDetails:O,watchDeliveryDetails:G,resetCheckout:q}}export{le as u};
