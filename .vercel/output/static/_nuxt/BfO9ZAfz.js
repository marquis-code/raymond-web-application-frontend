import{I as N,r as u,E as H,N as Z,aa as oe,S as ne,j as D,D as le}from"./AuNEgqM-.js";const ue=""+new URL("logo_main.Dt0GQpE3.png",import.meta.url).href,ee={$_create_order(t){return N.post("/orders",t)},$_fetch_all_orders(){return N.get("/orders")},$_fetch_my_orders(t){return N.get("/orders/my-orders",{params:t})},$_get_order_statistics(){return N.get("/orders/statistics")},$_get_recent_orders(t){return N.get("/orders/recent",{params:t?{limit:t}:{}})},$_find_by_order_number(t){return N.get(`/orders/number/${t}`)},$_find_order_by_id(t){return N.get(`/orders/${t}`)},$_update_order_status(t,r){return N.patch(`/orders/${t}/status`,r)}},te=()=>{const t=u(!1),r=u(null);return{loading:t,error:r,updateOrderStatus:async(n,i)=>{var s,m;t.value=!0,r.value=null;try{return await ee.$_update_order_status(n,i),!0}catch(d){throw r.value=((m=(s=d.response)==null?void 0:s.data)==null?void 0:m.message)||"Failed to update order status",r.value}finally{t.value=!1}}}},ce={$_verify_payment(t){return N.post("/payments/verify",t)}},ie=()=>{const t=u(!1),r=u(null);return{loading:t,error:r,verifyPayment:async n=>{var i,s;t.value=!0,r.value=null;try{return await ce.$_verify_payment(n),!0}catch(m){throw r.value=((s=(i=m.response)==null?void 0:i.data)==null?void 0:s.message)||"Failed to verify payment",r.value}finally{t.value=!1}}}},me={$_create_transaction(t){return N.post("/transactions",t)}},de=()=>{const t=u(!1),r=u(null),g=u({});return{loading:t,apiRes:g,error:r,createTransaction:async i=>{var s,m;t.value=!0,r.value=null;try{const d=await me.$_create_transaction(i);return g.value=d,d}catch(d){throw r.value=((m=(s=d.response)==null?void 0:s.data)==null?void 0:m.message)||"Failed to create transaction",r.value}finally{t.value=!1}}}},ve=()=>{const t=H(),{updateOrderStatus:r}=te(),{createTransaction:g,apiRes:n}=de(),{verifyPayment:i}=ie(),s=u({firstname:"",lastname:"",email:"",phone:""}),m=u({amount:"",orderRef:"",customerEmail:"",customerName:"",customerPhone:""}),d=u(!1),C=u(null),x=u(null),p=u({}),U=Z(()=>`${s.value.firstname} ${s.value.lastname}`),j=()=>`ngn-tx-${Date.now()}-${Math.floor(Math.random()*1e6)}`,J=e=>{e&&(s.value.firstname=e.firstName||s.value.firstname,s.value.lastname=e.lastName||s.value.lastname,s.value.email=e.email||s.value.email,s.value.phone=e.phone||s.value.phone)},L=()=>{var w;if(!x.value){console.warn("Payment data not set before initializing Flutterwave.");return}const e=x.value;C.value=oe.useFlutterwave({amount:Number(e.amount),callback:async v=>{var O,$,S,T,Y,l,c,a,y,h,o,z;if(console.log(v.flw_ref,"Payment callback received"),console.log(p,"incoming order details accessed from callbac"),console.log(v,"fluttter datda"),v.status==="successful")try{const K={user:p.value.customer,type:"payment",amount:((O=v.order)==null?void 0:O.total)||e.amount,status:"successful",order:(($=p==null?void 0:p.value)==null?void 0:$.id)||((S=p==null?void 0:p.value)==null?void 0:S._id),paymentMethod:((T=v.order)==null?void 0:T.paymentMethod)||"flutterwave",paymentReference:v.flw_ref||((Y=v.order)==null?void 0:Y.tranxReference),currency:"NGN",description:`Payment for order #${((l=p==null?void 0:p.value)==null?void 0:l.orderNumber)||v.flw_ref}`},ae=await g(K);console.log(ae," res from transaction creation");const re={transactionId:(a=(c=n==null?void 0:n.value)==null?void 0:c.data)==null?void 0:a.transactionId,reference:(h=(y=n==null?void 0:n.value)==null?void 0:y.data)==null?void 0:h.paymentReference};(z=(o=n==null?void 0:n.value)==null?void 0:o.data)!=null&&z.transactionId&&await i(re);const se={status:"processing",notes:"",trackingNumber:"",trackingUrl:"",estimatedDelivery:""},X=p.value.id||p.value._id;X?(await r(X,se),d.value=!1,t.push(`/order-success?tranxId=${v.flw_ref||e.tx_ref}&amount=${v.amount||e.amount}`),window.location.href=`/order-success?tranxId=${v.flw_ref||e.tx_ref}&amount=${v.amount||e.amount}`):(console.error("Order ID is missing"),d.value=!1)}catch(K){console.error("Error processing successful payment:",K),d.value=!1}else d.value=!1,console.error("Payment was not successful")},currency:"NGN",country:"NG",customer:{email:e.customerEmail,name:e.customerName,phone_number:e.customerPhone},customizations:{description:"Order Payment",logo:ue,title:"Raymond Aworo Art"},meta:{transaction_type:"local",order_ref:((w=e.orderDetails)==null?void 0:w.orderRef)||m.value.orderRef||"none"},onclose(){d.value=!1,console.log("Payment modal closed")},payment_options:"card,ussd,banktransfer",public_key:"FLWPUBK_TEST-8b2ac90831ce1269e39123cafea6275a-X",redirect_url:void 0,tx_ref:e.tx_ref})};return{handlePayment:async(e=null)=>{console.log(e,"incomign order details"),p.value=e;try{d.value=!0;const w=(e==null?void 0:e.customerName)||U.value,v=(e==null?void 0:e.customerEmail)||s.value.email,O=(e==null?void 0:e.customerPhone)||s.value.phone,$=e!=null&&e.orderRef?`order-${e.orderRef}`:j(),S=(e==null?void 0:e.amount)||m.value.amount,T={amount:Number(S),customerEmail:v,customerName:w,customerPhone:O,tx_ref:$,orderDetails:e};x.value=T,L(),C.value&&C.value.init()}catch(w){console.error("Error initiating payment:",w),d.value=!1}},paymentForm:m,loading:d,generateTxRef:j,setOrderDetails:(e,w,v=null)=>{m.value.orderRef=e,m.value.amount=w,v&&(m.value.customerEmail=v.email||s.value.email,m.value.customerName=`${v.firstName||""} ${v.lastName||""}`.trim()||U.value,m.value.customerPhone=v.phone||s.value.phone)},updateUserData:J}},fe=()=>{const t=u(!1),r=u(null),g=u({});return{loading:t,apiRes:g,error:r,createOrder:async i=>{var s,m;t.value=!0,r.value=null;try{const d=await ee.$_create_order(i);return g.value=d,d}catch(d){throw r.value=((m=(s=d.response)==null?void 0:s.data)==null?void 0:m.message)||"Failed to create order",r.value}finally{t.value=!1}}}},ye=()=>({setItem:(n,i)=>{try{localStorage.setItem(n,i)}catch(s){console.error("Error setting localStorage item:",s)}},getItem:n=>{try{return localStorage.getItem(n)}catch(i){return console.error("Error getting localStorage item:",i),null}},removeItem:n=>{try{localStorage.removeItem(n)}catch(i){console.error("Error removing localStorage item:",i)}}}),Q={firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",country:"United States"},V={cardNumber:"",cardName:"",expiryDate:"",cvv:""},b=u(1),P=u({items:[],subtotal:0,shipping:0,total:0,tax:0}),f=D({...Q}),M=u("standard"),k=u("flutterwave"),W=D({...V}),I=u(!1),R=u(!1),A=u("");u(1);const E=u(null),{loading:pe,createOrder:B}=fe();te();const{showToast:_}=le(),q=u(!1);function he(){H();const{isLoggedIn:t,user:r}=ne(),{setItem:g,getItem:n,removeItem:i}=ye(),{handlePayment:s,paymentForm:m,loading:d,updateUserData:C}=ve(),x=l=>{l&&l.items&&Array.isArray(l.items)&&(P.value=l);const c=n("checkout-step");c?b.value=Number.parseInt(c):b.value=1,R.value=!1,E.value=null;const a=n("checkout-delivery-details");if(a)try{const o=JSON.parse(a);Object.assign(f,o)}catch(o){console.error("Failed to parse saved delivery details",o)}else t.value&&r.value?(f.firstName=r.value.firstName||"",f.lastName=r.value.lastName||"",f.email=r.value.email||"",f.phone=r.value.phone||""):Object.assign(f,Q);const y=n("checkout-delivery-method");y&&["standard","express","pickup"].includes(y)?M.value=y:M.value="standard";const h=n("checkout-payment-method");h&&["flutterwave","interswitch","manual"].includes(h)?k.value=h:k.value="flutterwave",Object.assign(W,V),q.value=!0},p=()=>{b.value<3&&(b.value++,L())},U=()=>{b.value>1&&(b.value--,L())},j=l=>{M.value=l,g("checkout-delivery-method",l)},J=l=>{k.value=l,g("checkout-payment-method",l)},L=()=>{g("checkout-step",b.value.toString())},G=()=>{g("checkout-delivery-details",JSON.stringify(f))},F=()=>{i("checkout-step"),i("checkout-delivery-details"),i("checkout-delivery-method"),i("checkout-payment-method"),i("checkout-guest-mode")},e=()=>{b.value=1,R.value=!1,E.value=null,Object.assign(f,Q),Object.assign(W,V),M.value="standard",k.value="flutterwave",F(),q.value=!1},w=()=>{if(!P.value||!P.value.items||!Array.isArray(P.value.items))throw new Error("Checkout summary is not properly initialized");G();const l=P.value.items.map(a=>({product:a.id.toString(),quantity:a.quantity})),c={firstName:f.firstName,lastName:f.lastName,address:f.address,city:f.city,state:f.state,country:f.country,postalCode:f.zipCode,phone:f.phone,email:f.email};return{items:l,shippingAddress:c,billingAddress:c,notes:`Delivery Method: ${M.value}, Payment Method: ${k.value}`}},v=async()=>{var l,c,a,y;if(!P.value||!P.value.items)return _({title:"Error",message:"Your cart data could not be loaded. Please try refreshing the page.",toastType:"error",duration:3e3}),{success:!1,message:"Cart data not available"};I.value=!0;try{const h=w(),o=await B(h);if(console.log(o,"create order res"),o&&o.type!=="ERROR")return E.value=o,A.value=((l=o==null?void 0:o.data)==null?void 0:l.id)||((c=o==null?void 0:o.data)==null?void 0:c._id)||"INTL-ORD-"+Math.floor(Math.random()*1e6),C({firstName:f.firstName,lastName:f.lastName,email:f.email,phone:f.phone}),m.value.amount=(a=o==null?void 0:o.data)==null?void 0:a.total,m.value.tx_ref=A.value,await s(o==null?void 0:o.data),R.value&&F(),{success:!0};{const z=((y=o==null?void 0:o.data)==null?void 0:y.message)||"Order creation failed";return _({title:"Error",message:z,toastType:"warning",duration:3e3}),{success:!1,message:z}}}catch(h){console.error("Order creation or payment initialization failed",h);const o=(h==null?void 0:h.message)||"Payment processing failed";return _({title:"Payment Error",message:o,toastType:"error",duration:3e3}),{success:!1,message:o}}finally{I.value=!1}},O=async()=>{var l;if(!P.value||!P.value.items)return _({title:"Error",message:"Your cart data could not be loaded. Please try refreshing the page.",toastType:"error",duration:3e3}),{success:!1,message:"Cart data not available"};I.value=!0;try{const c=w(),a=await B(c);if(a&&a.type!=="ERROR")return E.value=a,A.value=a.id||a._id||"INTL-ORD-"+Math.floor(Math.random()*1e6),console.warn("Interswitch payment not configured for international transactions"),_({title:"Payment Method Unavailable",message:"Interswitch payment is not currently available for international transactions.",toastType:"warning",duration:3e3}),{success:!1,message:"Payment method unavailable"};{const y=((l=a==null?void 0:a.data)==null?void 0:l.message)||"Order creation failed";return _({title:"Error",message:y,toastType:"warning",duration:3e3}),{success:!1,message:y}}}catch(c){console.error("Order creation or payment failed",c);const a=(c==null?void 0:c.message)||"Payment processing failed";return _({title:"Payment Error",message:a,toastType:"error",duration:3e3}),{success:!1,message:a}}finally{I.value=!1}},$=async()=>{var l;if(!P.value||!P.value.items)return _({title:"Error",message:"Your cart data could not be loaded. Please try refreshing the page.",toastType:"error",duration:3e3}),{success:!1,message:"Cart data not available"};I.value=!0;try{const c=w(),a=await B(c);if(a&&a.type!=="ERROR")return E.value=a,A.value=a.id||a._id||"INTL-ORD-"+Math.floor(Math.random()*1e6),await new Promise(y=>setTimeout(y,2e3)),R.value=!0,F(),_({title:"Payment Successful",message:"Your order has been placed successfully!",toastType:"success",duration:3e3}),{success:!0};{const y=((l=a==null?void 0:a.data)==null?void 0:l.message)||"Order creation failed";return _({title:"Error",message:y,toastType:"warning",duration:3e3}),{success:!1,message:y}}}catch(c){console.error("Order creation or payment failed",c);const a=(c==null?void 0:c.message)||"Payment processing failed";return _({title:"Payment Error",message:a,toastType:"error",duration:3e3}),{success:!1,message:a}}finally{I.value=!1}},S=async()=>{if(!q.value)return _({title:"Error",message:"Checkout data is not properly initialized. Please refresh the page and try again.",toastType:"error",duration:3e3}),{success:!1,message:"Checkout not initialized"};switch(k.value){case"flutterwave":return v();case"interswitch":return O();case"manual":return $();default:return _({title:"Error",message:"Invalid payment method selected",toastType:"error",duration:3e3}),{success:!1,message:"Invalid payment method"}}},T=l=>l&&E.value?(R.value=!0,I.value=!1,F(),!0):!1,Y=()=>{G()};return{checkoutStep:b,checkoutSummary:P,deliveryDetails:f,deliveryMethod:M,paymentMethod:k,cardDetails:W,isProcessing:I,orderComplete:R,orderId:A,orderResponse:E,isInitialized:q,loading:Z(()=>pe.value||d.value),initializeCheckout:x,nextStep:p,prevStep:U,setDeliveryMethod:j,setPaymentMethod:J,processPayment:S,checkPaymentStatus:T,persistDeliveryDetails:G,watchDeliveryDetails:Y,resetCheckout:e}}export{ye as a,he as u};
