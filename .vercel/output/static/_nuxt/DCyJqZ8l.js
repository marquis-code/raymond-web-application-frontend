import{r as s,q as X,C as Y,R as re,b as H}from"./B5Rw5mES.js";import{G as w,u as oe}from"./Do8tO0gS.js";const ne=""+new URL("logo_main.Dt0GQpE3.png",import.meta.url).href,Z={$_create_order(t){return w.post("/orders",t)},$_fetch_all_orders(){return w.get("/orders")},$_fetch_my_orders(t){return w.get("/orders/my-orders",{params:t})},$_get_order_statistics(){return w.get("/orders/statistics")},$_get_recent_orders(t){return w.get("/orders/recent",{params:t?{limit:t}:{}})},$_find_by_order_number(t){return w.get(`/orders/number/${t}`)},$_find_order_by_id(t){return w.get(`/orders/${t}`)},$_update_order_status(t,a){return w.patch(`/orders/${t}/status`,a)}},D=()=>{const t=s(!1),a=s(null);return{loading:t,error:a,updateOrderStatus:async(o,l)=>{var r,u;t.value=!0,a.value=null;try{return await Z.$_update_order_status(o,l),!0}catch(c){throw a.value=((u=(r=c.response)==null?void 0:r.data)==null?void 0:u.message)||"Failed to update order status",a.value}finally{t.value=!1}}}},se={$_verify_payment(t){return w.post("/payments/verify",t)}},le=()=>{const t=s(!1),a=s(null);return{loading:t,error:a,verifyPayment:async o=>{var l,r;t.value=!0,a.value=null;try{return await se.$_verify_payment(o),!0}catch(u){throw a.value=((r=(l=u.response)==null?void 0:l.data)==null?void 0:r.message)||"Failed to verify payment",a.value}finally{t.value=!1}}}},ue={$_create_transaction(t){return w.post("/transactions",t)}},ce=()=>{const t=s(!1),a=s(null),y=s({});return{loading:t,apiRes:y,error:a,createTransaction:async l=>{var r,u;t.value=!0,a.value=null;try{const c=await ue.$_create_transaction(l);return y.value=c,c}catch(c){throw a.value=((u=(r=c.response)==null?void 0:r.data)==null?void 0:u.message)||"Failed to create transaction",a.value}finally{t.value=!1}}}},ie=()=>{const t=X(),{updateOrderStatus:a}=D(),{createTransaction:y,apiRes:o}=ce(),{verifyPayment:l}=le(),r=s({firstname:"",lastname:"",email:"",phone:""}),u=s({amount:"",orderRef:"",customerEmail:"",customerName:"",customerPhone:""}),c=s(!1),C=s(null),F=s(null),f=s({}),L=Y(()=>`${r.value.firstname} ${r.value.lastname}`),U=()=>`ngn-tx-${Date.now()}-${Math.floor(Math.random()*1e6)}`,G=e=>{e&&(r.value.firstname=e.firstName||r.value.firstname,r.value.lastname=e.lastName||r.value.lastname,r.value.email=e.email||r.value.email,r.value.phone=e.phone||r.value.phone)},j=()=>{var h;if(!F.value){console.warn("Payment data not set before initializing Flutterwave.");return}const e=F.value;C.value=re.useFlutterwave({amount:Number(e.amount),callback:async i=>{var O,S,R,E,A,n,v,p,g,m,M,Q;if(console.log(i.flw_ref,"Payment callback received"),console.log(f,"incoming order details accessed from callbac"),console.log(i,"fluttter datda"),i.status==="successful")try{const q={user:f.value.customer,type:"payment",amount:((O=i.order)==null?void 0:O.total)||e.amount,status:"successful",order:((S=f==null?void 0:f.value)==null?void 0:S.id)||((R=f==null?void 0:f.value)==null?void 0:R._id),paymentMethod:((E=i.order)==null?void 0:E.paymentMethod)||"flutterwave",paymentReference:i.flw_ref||((A=i.order)==null?void 0:A.tranxReference),currency:"NGN",description:`Payment for order #${((n=f==null?void 0:f.value)==null?void 0:n.orderNumber)||i.flw_ref}`},ee=await y(q);console.log(ee," res from transaction creation");const te={transactionId:(p=(v=o==null?void 0:o.value)==null?void 0:v.data)==null?void 0:p.transactionId,reference:(m=(g=o==null?void 0:o.value)==null?void 0:g.data)==null?void 0:m.paymentReference};(Q=(M=o==null?void 0:o.value)==null?void 0:M.data)!=null&&Q.transactionId&&await l(te);const ae={status:"processing",notes:"",trackingNumber:"",trackingUrl:"",estimatedDelivery:""},V=f.value.id||f.value._id;V?(await a(V,ae),c.value=!1,t.push(`/order-success?tranxId=${i.flw_ref||e.tx_ref}&amount=${i.amount||e.amount}`),window.location.href=`/order-success?tranxId=${i.flw_ref||e.tx_ref}&amount=${i.amount||e.amount}`):(console.error("Order ID is missing"),c.value=!1)}catch(q){console.error("Error processing successful payment:",q),c.value=!1}else c.value=!1,console.error("Payment was not successful")},currency:"NGN",country:"NG",customer:{email:e.customerEmail,name:e.customerName,phone_number:e.customerPhone},customizations:{description:"Order Payment",logo:ne,title:"Raymond Aworo Art"},meta:{transaction_type:"local",order_ref:((h=e.orderDetails)==null?void 0:h.orderRef)||u.value.orderRef||"none"},onclose(){c.value=!1,console.log("Payment modal closed")},payment_options:"card,ussd,banktransfer",public_key:"FLWPUBK_TEST-8b2ac90831ce1269e39123cafea6275a-X",redirect_url:void 0,tx_ref:e.tx_ref})};return{handlePayment:async(e=null)=>{console.log(e,"incomign order details"),f.value=e;try{c.value=!0;const h=(e==null?void 0:e.customerName)||L.value,i=(e==null?void 0:e.customerEmail)||r.value.email,O=(e==null?void 0:e.customerPhone)||r.value.phone,S=e!=null&&e.orderRef?`order-${e.orderRef}`:U(),R=(e==null?void 0:e.amount)||u.value.amount,E={amount:Number(R),customerEmail:i,customerName:h,customerPhone:O,tx_ref:S,orderDetails:e};F.value=E,j(),C.value&&C.value.init()}catch(h){console.error("Error initiating payment:",h),c.value=!1}},paymentForm:u,loading:c,generateTxRef:U,setOrderDetails:(e,h,i=null)=>{u.value.orderRef=e,u.value.amount=h,i&&(u.value.customerEmail=i.email||r.value.email,u.value.customerName=`${i.firstName||""} ${i.lastName||""}`.trim()||L.value,u.value.customerPhone=i.phone||r.value.phone)},updateUserData:G}},me=()=>{const t=s(!1),a=s(null),y=s({});return{loading:t,apiRes:y,error:a,createOrder:async l=>{var r,u;t.value=!0,a.value=null;try{const c=await Z.$_create_order(l);return y.value=c,c}catch(c){throw a.value=((u=(r=c.response)==null?void 0:r.data)==null?void 0:u.message)||"Failed to create order",a.value}finally{t.value=!1}}}},de=()=>({setItem:(o,l)=>{try{localStorage.setItem(o,l)}catch(r){console.error("Error setting localStorage item:",r)}},getItem:o=>{try{return localStorage.getItem(o)}catch(l){return console.error("Error getting localStorage item:",l),null}},removeItem:o=>{try{localStorage.removeItem(o)}catch(l){console.error("Error removing localStorage item:",l)}}}),W={firstName:"",lastName:"",email:"",phone:"",address:"",city:"",state:"",zipCode:"",country:"United States"},B={cardNumber:"",cardName:"",expiryDate:"",cvv:""},N=s(1),P=s(null),d=H({...W}),x=s("standard"),$=s("flutterwave"),J=H({...B}),_=s(!1),I=s(!1),T=s("");s(1);const b=s(null),{loading:ve,createOrder:K}=me();D();function pe(){X();const{isLoggedIn:t,user:a}=oe(),{setItem:y,getItem:o,removeItem:l}=de(),{handlePayment:r,paymentForm:u,loading:c,updateUserData:C}=ie(),F=n=>{P.value=n;const v=o("checkout-step");v?N.value=Number.parseInt(v):N.value=1,I.value=!1,b.value=null;const p=o("checkout-delivery-details");if(p)try{const M=JSON.parse(p);Object.assign(d,M)}catch(M){console.error("Failed to parse saved delivery details",M)}else t.value&&a.value?(d.firstName=a.value.firstName||"",d.lastName=a.value.lastName||"",d.email=a.value.email||"",d.phone=a.value.phone||""):Object.assign(d,W);const g=o("checkout-delivery-method");g&&["standard","express","pickup"].includes(g)?x.value=g:x.value="standard";const m=o("checkout-payment-method");m&&["flutterwave","interswitch","manual"].includes(m)?$.value=m:$.value="flutterwave",Object.assign(J,B)},f=()=>{N.value<3&&(N.value++,j())},L=()=>{N.value>1&&(N.value--,j())},U=n=>{x.value=n,y("checkout-delivery-method",n)},G=n=>{$.value=n,y("checkout-payment-method",n)},j=()=>{y("checkout-step",N.value.toString())},z=()=>{y("checkout-delivery-details",JSON.stringify(d))},k=()=>{l("checkout-step"),l("checkout-delivery-details"),l("checkout-delivery-method"),l("checkout-payment-method"),l("checkout-guest-mode")},e=()=>{N.value=1,I.value=!1,b.value=null,Object.assign(d,W),Object.assign(J,B),x.value="standard",$.value="flutterwave",k()},h=()=>{if(!P.value)throw new Error("Checkout summary is not initialized");z();const n=P.value.items.map(p=>({product:p.id.toString(),quantity:p.quantity})),v={firstName:d.firstName,lastName:d.lastName,address:d.address,city:d.city,state:d.state,country:d.country,postalCode:d.zipCode,phone:d.phone,email:d.email};return{items:n,shippingAddress:v,billingAddress:v,notes:`Delivery Method: ${x.value}, Payment Method: ${$.value}`}},i=async()=>{var n,v,p;if(P.value){_.value=!0;try{const g=h(),m=await K(g);console.log(m,"create order res"),m.type!=="ERROR"&&(b.value=m,T.value=((n=m==null?void 0:m.data)==null?void 0:n.id)||((v=m==null?void 0:m.data)==null?void 0:v._id)||"INTL-ORD-"+Math.floor(Math.random()*1e6),C({firstName:d.firstName,lastName:d.lastName,email:d.email,phone:d.phone}),u.value.amount=(p=m==null?void 0:m.data)==null?void 0:p.total,u.value.tx_ref=T.value,await r(m==null?void 0:m.data),I.value&&k())}catch(g){console.error("Order creation or payment initialization failed",g),_.value=!1}finally{_.value=!1}}},O=async()=>{if(P.value){_.value=!0;try{const n=h(),v=await K(n);if(v.type!=="ERROR"){b.value=v,T.value=v.id||v._id||"INTL-ORD-"+Math.floor(Math.random()*1e6),console.warn("Interswitch payment not configured for international transactions"),_.value=!1,I.value&&k();return}}catch(n){console.error("Order creation or payment failed",n),_.value=!1}}},S=async()=>{if(P.value){_.value=!0;try{const n=h(),v=await K(n);v.type!=="ERROR"&&(b.value=v,T.value=v.id||v._id||"INTL-ORD-"+Math.floor(Math.random()*1e6),await new Promise(p=>setTimeout(p,2e3)),I.value=!0,k())}catch(n){console.error("Order creation or payment failed",n)}finally{_.value=!1}}},R=async()=>{switch($.value){case"flutterwave":return i();case"interswitch":return O();case"manual":return S()}},E=n=>n&&b.value?(I.value=!0,_.value=!1,k(),!0):!1,A=()=>{z()};return{checkoutStep:N,checkoutSummary:P,deliveryDetails:d,deliveryMethod:x,paymentMethod:$,cardDetails:J,isProcessing:_,orderComplete:I,orderId:T,orderResponse:b,loading:Y(()=>ve.value||c.value),initializeCheckout:F,nextStep:f,prevStep:L,setDeliveryMethod:U,setPaymentMethod:G,processPayment:R,checkPaymentStatus:E,persistDeliveryDetails:z,watchDeliveryDetails:A,resetCheckout:e}}export{de as a,pe as u};
